<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Testing concurrent code using DejaFu Â» nicolast.be</title>
<meta name="description" content="Writing correct concurrent code with shared mutable state is hard. Testing concurrent code with shared mutable state is hard. In Haskell, we can use STM to transactionally change state, and DejaFu to test concurrent code. In this post, we look into how this is done, and discuss an approach to simplify the testing effort.">


  <meta name="author" content="Nicolas T.">
  
  <meta property="article:author" content="Nicolas T.">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en">
<meta property="og:site_name" content="nicolast.be">
<meta property="og:title" content="Testing concurrent code using DejaFu">
<meta property="og:url" content="https://nicolast.be/development/testing-concurrent-code-using-dejafu/">


  <meta property="og:description" content="Writing correct concurrent code with shared mutable state is hard. Testing concurrent code with shared mutable state is hard. In Haskell, we can use STM to transactionally change state, and DejaFu to test concurrent code. In this post, we look into how this is done, and discuss an approach to simplify the testing effort.">



  <meta property="og:image" content="https://nicolast.be/assets/images/27174457817_7b6cc225e4_c.jpg">



  <meta name="twitter:site" content="@eikke">
  <meta name="twitter:title" content="Testing concurrent code using DejaFu">
  <meta name="twitter:description" content="Writing correct concurrent code with shared mutable state is hard. Testing concurrent code with shared mutable state is hard. In Haskell, we can use STM to transactionally change state, and DejaFu to test concurrent code. In this post, we look into how this is done, and discuss an approach to simplify the testing effort.">
  <meta name="twitter:url" content="https://nicolast.be/development/testing-concurrent-code-using-dejafu/">

  
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://nicolast.be/assets/images/27174457817_7b6cc225e4_c.jpg">
  

  
    <meta name="twitter:creator" content="@eikke">
  



  <meta property="article:published_time" content="2023-04-06T21:17:00+02:00">



  <meta property="article:modified_time" content="2023-04-14T21:31:00+02:00">




<link rel="canonical" href="https://nicolast.be/development/testing-concurrent-code-using-dejafu/">







  <meta name="google-site-verification" content="7SXobc1ltJXe4Xqy_ZBZJEVc1sWPi03lIkaHIXCiNqc" />






<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="nicolast.be Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="76x76" href="/assets/images/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/assets/images/favicon/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/assets/images/favicon/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/assets/images/favicon/manifest.json">
<link rel="mask-icon" href="/assets/images/favicon/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/assets/images/favicon/favicon.ico">
<meta name="msapplication-config" content="/assets/images/favicon/browserconfig.xml">
<meta name="theme-color" content="#ffffff">

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          nicolast.be
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a
                href="/categories/"
                
                
              >Categories</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('/assets/images/27174457817_7b6cc225e4_c.jpg');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Testing concurrent code using DejaFu

        
      </h1>
      
        <p class="page__lead">Writing correct concurrent code with shared mutable state is hard. Testing concurrent code with shared mutable state is hard. In Haskell, we can use STM to transactionally change state, and DejaFu to test concurrent code. In this post, we look into how this is done, and discuss an approach to simplify the testing effort.
</p>
      
      

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          11 minute read
        
      </span>
    
  </p>


      
    </div>
  
  
    <span class="page__hero-caption">Photo credit: <a href="https://www.flickr.com/photos/157270154@N05/27174457817"><strong>Mike Lawrence</strong></a>
</span>
  
</div>







<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://nicolast.be/">
        <img src="/assets/images/avatar-nicolas.jpg" alt="Nicolas T." itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://nicolast.be/" itemprop="url">Nicolas T.</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Software guy, former Principal Architect @ Scality. <a href="http://haskell.org">Haskell</a>â€˜ist, music-lover and startup-minded.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">ðŸ‡«ðŸ‡· Paris | ðŸ‡§ðŸ‡ª Antwerp</span>
        </li>
      

      

      

      
        <li>
          <a href="mailto:ikke@nicolast.be" rel="me" class="u-email">
            <meta itemprop="email" content="ikke@nicolast.be" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span>
          </a>
        </li>
      

      

      
        <li>
          <a href="https://twitter.com/eikke" itemprop="sameAs" rel="nofollow noopener noreferrer me">
            <i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span>
          </a>
        </li>
      

      

      
        <li>
          <a href="https://www.linkedin.com/in/nicolastrangez" itemprop="sameAs" rel="nofollow noopener noreferrer me">
            <i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span>
          </a>
        </li>
      

      

      

      

      

      
        <li>
          <a href="https://github.com/NicolasT" itemprop="sameAs" rel="nofollow noopener noreferrer me">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span>
          </a>
        </li>
      

      

      
        <li>
          <a href="https://stackoverflow.com/users/1285443/nicolas-trangez" itemprop="sameAs" rel="nofollow noopener noreferrer me">
            <i class="fab fa-fw fa-stack-overflow" aria-hidden="true"></i><span class="label">Stack Overflow</span>
          </a>
        </li>
      

      
        <li>
          <a href="https://last.fm/user/eikke" itemprop="sameAs" rel="nofollow noopener noreferrer me">
            <i class="fab fa-fw fa-lastfm-square" aria-hidden="true"></i><span class="label">Last.fm</span>
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Testing concurrent code using DejaFu">
    <meta itemprop="description" content="Writing correct concurrent code with shared mutable state is hard. Testing concurrent code with shared mutable state is hard. In Haskell, we can use STM to transactionally change state, and DejaFu to test concurrent code. In this post, we look into how this is done, and discuss an approach to simplify the testing effort.">
    <meta itemprop="datePublished" content="2023-04-06T21:17:00+02:00">
    <meta itemprop="dateModified" content="2023-04-14T21:31:00+02:00">

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
        <p>Recently I was working on some code using <a href="https://www.haskell.org/ghc/">GHC</a>
<a href="https://www.haskell.org">Haskell</a>â€™s <a href="https://hackage.haskell.org/package/stm">STM</a> (short for
Software Transactional Memory)
functionality. STM gives a programmer mutable variables (so-called <code class="language-plaintext highlighter-rouge">TVar</code>s), functions to work on such
variables in some context (e.g., <code class="language-plaintext highlighter-rouge">writeTVar :: TVar a -&gt; a -&gt; STM ()</code>), and a way to run a program
working with such variables transactionally (<code class="language-plaintext highlighter-rouge">atomically :: STM a -&gt; IO a</code>). The transactional aspect
is what makes STM so powerful: when multiple threads of execution mutate the same <code class="language-plaintext highlighter-rouge">TVar</code>s concurrently,
a transaction will be automatically aborted and restarted by the runtime upon conflicts. As such, we
can construct programs working with one or more mutable variables, without the need for explicit locking.</p>

<p>The above only scratches the surface of whatâ€™s possible with STM. To learn more, see
<a href="https://book.realworldhaskell.org/read/software-transactional-memory.html">chapter 28</a>
of <a href="https://book.realworldhaskell.org/">Real World Haskell</a>.</p>

<p>STM makes writing concurrent code with shared mutable state easier, but still leaves room for mistakes.
Code with mutable state, especially with concurrent access to shared mutable state, is more difficult
to test than pure computations. Using <a href="https://hackage.haskell.org/package/dejafu">DejaFu</a>, we can
write tests of concurrent code which will simulate various schedulings of application threads and
validate the result, e.g., by ensuring a program yields the same value no matter the order in which
threads were scheduled, or by ensuring some invariants were maintained at every observable point in
time. In this post, I want to show two patterns I adopted when writing concurrent code, using STM,
with the ability to test it using DejaFu. If youâ€™re not familiar with the latter, you can find more
information on its <a href="https://dejafu.readthedocs.io/en/latest/getting_started.html#why-deja-fu">website</a>.</p>

<p>First, some boilerplate so this post can be executed as a Literal Haskell script:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">{- cabal: 
build-depends:
  , base ^&gt;=4.17.0.0
  , concurrency ^&gt;=1.11.0.2
  , exceptions ^&gt;=0.10.7
  , tasty ^&gt;=1.4.3
  , tasty-dejafu ^&gt;=2.1.0.0
build-tool-depends: markdown-unlit:markdown-unlit
ghc-options: -threaded -pgmL markdown-unlit -Wall -Werror
default-language: Haskell2010
-}</span>
</code></pre></div></div>

<p>To test code using DejaFu, it canâ€™t be written using, e.g., <code class="language-plaintext highlighter-rouge">readTVar :: TVar a -&gt; STM a</code>, but
instead needs to use the abstractions provided by the
<a href="https://hackage.haskell.org/package/concurrency-1.11.0.2"><code class="language-plaintext highlighter-rouge">concurrency</code></a> package, e.g.,
<code class="language-plaintext highlighter-rouge">readTVar :: MonadSTM stm =&gt; TVar stm a -&gt; stm a</code>. Notice how the <code class="language-plaintext highlighter-rouge">TVar</code> type is parametrized
by the monad in which itâ€™ll be used. This allows for use in the traditional <code class="language-plaintext highlighter-rouge">STM</code> monad (which
is an instance of <code class="language-plaintext highlighter-rouge">MonadSTM</code>), as well as in emulations of it provided by DejaFu.</p>

<p>Furthermore, weâ€™ll use the <a href="https://hackage.haskell.org/package/exceptions-0.10.7"><code class="language-plaintext highlighter-rouge">exceptions</code></a>
package to throw exceptions while checking invariants, and the
<a href="https://hackage.haskell.org/package/tasty-1.4.3"><code class="language-plaintext highlighter-rouge">tasty</code></a> test framework, including DejaFu
integration for it brought by
<a href="https://hackage.haskell.org/package/tasty-dejafu-2.1.0.0"><code class="language-plaintext highlighter-rouge">tasty-dejafu</code></a> to define and run
some tests.</p>

<p>All good Haskell code starts with some <code class="language-plaintext highlighter-rouge">LANGUAGE</code> pragmas and some <code class="language-plaintext highlighter-rouge">import</code>s, so letâ€™s get those out
of the way:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">{-# LANGUAGE QuantifiedConstraints #-}</span>
<span class="cp">{-# LANGUAGE RankNTypes #-}</span>
<span class="cp">{-# LANGUAGE StandaloneDeriving #-}</span>
<span class="cp">{-# LANGUAGE UndecidableInstances #-}</span>

<span class="kr">import</span> <span class="nn">Control.Concurrent.Classy.Async</span> <span class="p">(</span><span class="nf">concurrently_</span><span class="p">,</span> <span class="nf">wait</span><span class="p">,</span> <span class="nf">withAsync</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Control.Concurrent.Classy.STM</span> <span class="p">(</span><span class="kt">TVar</span><span class="p">,</span> <span class="nf">readTVar</span><span class="p">,</span> <span class="nf">modifyTVar'</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Control.Monad</span> <span class="p">(</span><span class="nf">unless</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Control.Monad.Catch</span> <span class="p">(</span><span class="kt">Exception</span><span class="p">(</span><span class="o">..</span><span class="p">),</span> <span class="kt">MonadThrow</span><span class="p">,</span> <span class="nf">throwM</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Control.Monad.Conc.Class</span> <span class="p">(</span><span class="kt">MonadConc</span><span class="p">,</span> <span class="kt">STM</span><span class="p">,</span> <span class="nf">atomically</span><span class="p">,</span> <span class="nf">newTVarConc</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Control.Monad.STM.Class</span> <span class="p">(</span><span class="kt">MonadSTM</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Data.Functor.Identity</span> <span class="p">(</span><span class="kt">Identity</span><span class="p">(</span><span class="o">..</span><span class="p">))</span>
<span class="kr">import</span> <span class="nn">Test.Tasty</span> <span class="p">(</span><span class="nf">defaultMain</span><span class="p">,</span> <span class="nf">testGroup</span><span class="p">)</span>
<span class="kr">import</span> <span class="nn">Test.Tasty.DejaFu</span> <span class="p">(</span><span class="kt">Basic</span><span class="p">,</span> <span class="kt">Program</span><span class="p">,</span> <span class="kt">WithSetup</span><span class="p">,</span> <span class="nf">inspectTVar</span><span class="p">,</span> <span class="nf">registerInvariant</span><span class="p">,</span> <span class="nf">testAuto</span><span class="p">,</span> <span class="nf">withSetup</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="state-and-mutations">State and Mutations</h2>

<p>In the (admittedly contrived) example used throughout this post, our program keeps track of
two <code class="language-plaintext highlighter-rouge">Int</code> values, and provides two actions to mutate them: one to add an <code class="language-plaintext highlighter-rouge">Int</code> which will
add the given value to the first mutable variable and substract it from the second, and another
to substract an <code class="language-plaintext highlighter-rouge">Int</code> which will, as you may have guessed, substract the given value from the
first mutable variable and add it to the second. Hence, thereâ€™s an invariant that should be
maintained at all times: the sum of both mutable variables should be <code class="language-plaintext highlighter-rouge">0</code>.</p>

<h3 id="state-type">State Type</h3>

<p>In regular STM code, weâ€™d use a datatype like the following to maintain the state:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data Store = Store
  { storeA :: TVar Int,
    storeB :: TVar Int
  }
</code></pre></div></div>

<p>This works, but as mentioned before, we need to use the types provided by the <code class="language-plaintext highlighter-rouge">concurrency</code> package
to be able to test our code using DejaFu. Hence, we need to use its <code class="language-plaintext highlighter-rouge">TVar stm a</code> type (family)
instead:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data Store stm = Store
  { storeA :: TVar stm Int,
    storeB :: TVar stm Int
  }
</code></pre></div></div>

<p>This goes in the right direction, and indeed, we could provide implementations for <code class="language-plaintext highlighter-rouge">add</code> and <code class="language-plaintext highlighter-rouge">sub</code>
and test those. However, there are still some shortcomings:</p>

<ul>
  <li>
    <p>When checking invariants, writing code doing so in a <em>pure</em> style (modulo throwing exceptions)
simplifies the implementation a lot, instead of littering the validation code with <code class="language-plaintext highlighter-rouge">readTVar</code> calls
and monadic binds. This, in turn, makes testing of the invariants validation code easier as well.</p>
  </li>
  <li>
    <p>DejaFu can be used to validate a concurrent computation always yields the same result, which imposes
an <code class="language-plaintext highlighter-rouge">Eq</code> constraint on the result type. We often want to check the shared mutable state is the same
no matter which scheduling of mutators happened, but a data type with <code class="language-plaintext highlighter-rouge">TVar</code>s inside canâ€™t have an
<code class="language-plaintext highlighter-rouge">Eq</code> instance.</p>
  </li>
</ul>

<p>So, we build <code class="language-plaintext highlighter-rouge">Store</code> such that itâ€™s paramterized over a <code class="language-plaintext highlighter-rouge">cell</code> type which, for the mutable version
of <code class="language-plaintext highlighter-rouge">Store</code> will be some <code class="language-plaintext highlighter-rouge">TVar</code>, whilst <code class="language-plaintext highlighter-rouge">cell</code> can also be <code class="language-plaintext highlighter-rouge">Identity</code> in which case the resulting
type is immutable:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">data</span> <span class="kt">Store'</span> <span class="n">cell</span> <span class="o">=</span> <span class="kt">Store'</span>
  <span class="p">{</span> <span class="n">storeA</span> <span class="o">::</span> <span class="n">cell</span> <span class="kt">Int</span><span class="p">,</span>
    <span class="n">storeB</span> <span class="o">::</span> <span class="n">cell</span> <span class="kt">Int</span>
  <span class="p">}</span>

<span class="kr">deriving</span> <span class="kr">instance</span> <span class="p">(</span><span class="n">forall</span> <span class="n">a</span><span class="o">.</span> <span class="kt">Show</span> <span class="n">a</span> <span class="o">=&gt;</span> <span class="kt">Show</span> <span class="p">(</span><span class="n">cell</span> <span class="n">a</span><span class="p">))</span> <span class="o">=&gt;</span> <span class="kt">Show</span> <span class="p">(</span><span class="kt">Store'</span> <span class="n">cell</span><span class="p">)</span>
<span class="kr">deriving</span> <span class="kr">instance</span> <span class="p">(</span><span class="n">forall</span> <span class="n">a</span><span class="o">.</span> <span class="kt">Eq</span> <span class="n">a</span> <span class="o">=&gt;</span> <span class="kt">Eq</span> <span class="p">(</span><span class="n">cell</span> <span class="n">a</span><span class="p">))</span> <span class="o">=&gt;</span> <span class="kt">Eq</span> <span class="p">(</span><span class="kt">Store'</span> <span class="n">cell</span><span class="p">)</span>

<span class="kr">type</span> <span class="kt">FrozenStore</span> <span class="o">=</span> <span class="kt">Store'</span> <span class="kt">Identity</span>
<span class="kr">type</span> <span class="kt">Store</span> <span class="n">stm</span> <span class="o">=</span> <span class="kt">Store'</span> <span class="p">(</span><span class="kt">TVar</span> <span class="n">stm</span><span class="p">)</span>
</code></pre></div></div>

<p>As in the above, we can derive a <code class="language-plaintext highlighter-rouge">Show</code> and <code class="language-plaintext highlighter-rouge">Eq</code> instance for <code class="language-plaintext highlighter-rouge">Store' cell</code> as long as thereâ€™s
a <code class="language-plaintext highlighter-rouge">Show</code> and <code class="language-plaintext highlighter-rouge">Eq</code> instance for <code class="language-plaintext highlighter-rouge">cell a</code>, for all possible <code class="language-plaintext highlighter-rouge">a</code>s. This is not the case for <code class="language-plaintext highlighter-rouge">Store</code>
(e.g., thereâ€™s no <code class="language-plaintext highlighter-rouge">Show</code> instance for <code class="language-plaintext highlighter-rouge">TVar stm a</code>), but it is for <code class="language-plaintext highlighter-rouge">FrozenStore</code>.</p>

<h3 id="functions">Functions</h3>

<p>We can now define a function to create a new <code class="language-plaintext highlighter-rouge">Store</code>, and implement <code class="language-plaintext highlighter-rouge">add</code> and <code class="language-plaintext highlighter-rouge">sub</code>:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">newStoreConc</span> <span class="o">::</span> <span class="kt">MonadConc</span> <span class="n">m</span> <span class="o">=&gt;</span> <span class="n">m</span> <span class="p">(</span><span class="kt">Store</span> <span class="p">(</span><span class="kt">STM</span> <span class="n">m</span><span class="p">))</span>
<span class="n">newStoreConc</span> <span class="o">=</span>
  <span class="kt">Store'</span>
    <span class="o">&lt;$&gt;</span> <span class="n">newTVarConc</span> <span class="mi">0</span>
    <span class="o">&lt;*&gt;</span> <span class="n">newTVarConc</span> <span class="mi">0</span>

<span class="n">addSTM</span> <span class="o">::</span> <span class="kt">MonadSTM</span> <span class="n">stm</span> <span class="o">=&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Store</span> <span class="n">stm</span> <span class="o">-&gt;</span> <span class="n">stm</span> <span class="nb">()</span>
<span class="n">addSTM</span> <span class="n">i</span> <span class="n">store</span> <span class="o">=</span> <span class="kr">do</span>
  <span class="n">modifyTVar'</span> <span class="p">(</span><span class="n">storeA</span> <span class="n">store</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
  <span class="n">modifyTVar'</span> <span class="p">(</span><span class="n">storeB</span> <span class="n">store</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>

<span class="n">add</span> <span class="o">::</span> <span class="kt">MonadConc</span> <span class="n">m</span> <span class="o">=&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Store</span> <span class="p">(</span><span class="kt">STM</span> <span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="nb">()</span>
<span class="n">add</span> <span class="n">i</span> <span class="n">store</span> <span class="o">=</span> <span class="n">atomically</span> <span class="p">(</span><span class="n">addSTM</span> <span class="n">i</span> <span class="n">store</span><span class="p">)</span>

<span class="n">subSTM</span> <span class="o">::</span> <span class="kt">MonadSTM</span> <span class="n">stm</span> <span class="o">=&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Store</span> <span class="n">stm</span> <span class="o">-&gt;</span> <span class="n">stm</span> <span class="nb">()</span>
<span class="n">subSTM</span> <span class="n">i</span> <span class="n">store</span> <span class="o">=</span> <span class="kr">do</span>
  <span class="n">modifyTVar'</span> <span class="p">(</span><span class="n">storeA</span> <span class="n">store</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
  <span class="n">modifyTVar'</span> <span class="p">(</span><span class="n">storeB</span> <span class="n">store</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>

<span class="n">sub</span> <span class="o">::</span> <span class="kt">MonadConc</span> <span class="n">m</span> <span class="o">=&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Store</span> <span class="p">(</span><span class="kt">STM</span> <span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="nb">()</span>
<span class="n">sub</span> <span class="n">i</span> <span class="n">store</span> <span class="o">=</span> <span class="n">atomically</span> <span class="p">(</span><span class="n">subSTM</span> <span class="n">i</span> <span class="n">store</span><span class="p">)</span>
</code></pre></div></div>

<p>(Did you spot the bug?)</p>

<p>If the types in the code above are a bit daunting, when specialized to <code class="language-plaintext highlighter-rouge">IO</code> weâ€™d get</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import Control.Concurrent.STM (STM, TVar)

type Store = Store' TVar

-- | 'newStoreIO', so you want.
newStoreConc :: IO Store

addSTM :: Int -&gt; Store -&gt; STM ()
add :: Int -&gt; Store -&gt; IO ()

subSTM :: Int -&gt; Store -&gt; STM ()
sub :: Int -&gt; Store -&gt; IO ()
</code></pre></div></div>

<h3 id="snapshots">Snapshots</h3>

<p>The code above works on the mutable version of <code class="language-plaintext highlighter-rouge">Store'</code>. However, we went through this <code class="language-plaintext highlighter-rouge">cell</code>
hassle in order to get an immutable version of a <code class="language-plaintext highlighter-rouge">Store'</code> for use in invariant checks and
consistency tests. The following functions can be defined to turn a <code class="language-plaintext highlighter-rouge">Store stm</code> into an
<code class="language-plaintext highlighter-rouge">stm FrozenStore</code>:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">snapshotWith</span> <span class="o">::</span>
  <span class="kt">Applicative</span> <span class="n">m</span> <span class="o">=&gt;</span>
  <span class="p">(</span><span class="n">forall</span> <span class="n">a</span><span class="o">.</span> <span class="n">cell</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="kt">Store'</span> <span class="n">cell</span> <span class="o">-&gt;</span>
  <span class="n">m</span> <span class="kt">FrozenStore</span>
<span class="n">snapshotWith</span> <span class="n">readCell</span> <span class="n">store</span> <span class="o">=</span>
  <span class="kt">Store'</span>
    <span class="o">&lt;$&gt;</span> <span class="p">(</span><span class="kt">Identity</span> <span class="o">&lt;$&gt;</span> <span class="n">readCell</span> <span class="p">(</span><span class="n">storeA</span> <span class="n">store</span><span class="p">))</span>
    <span class="o">&lt;*&gt;</span> <span class="p">(</span><span class="kt">Identity</span> <span class="o">&lt;$&gt;</span> <span class="n">readCell</span> <span class="p">(</span><span class="n">storeB</span> <span class="n">store</span><span class="p">))</span>

<span class="n">snapshotSTM</span> <span class="o">::</span> <span class="kt">MonadSTM</span> <span class="n">stm</span> <span class="o">=&gt;</span> <span class="kt">Store</span> <span class="n">stm</span> <span class="o">-&gt;</span> <span class="n">stm</span> <span class="kt">FrozenStore</span>
<span class="n">snapshotSTM</span> <span class="o">=</span> <span class="n">snapshotWith</span> <span class="n">readTVar</span>

<span class="n">snapshot</span> <span class="o">::</span> <span class="kt">MonadConc</span> <span class="n">m</span> <span class="o">=&gt;</span> <span class="kt">Store</span> <span class="p">(</span><span class="kt">STM</span> <span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="kt">FrozenStore</span>
<span class="n">snapshot</span> <span class="o">=</span> <span class="n">atomically</span> <span class="o">.</span> <span class="n">snapshotSTM</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">snapshotWith</code> function is where the magic happens. It takes an action which, in some
<code class="language-plaintext highlighter-rouge">Applicative</code> context, can read the value of a <code class="language-plaintext highlighter-rouge">cell</code>, and can then turn a <code class="language-plaintext highlighter-rouge">Store' cell</code> into
a <code class="language-plaintext highlighter-rouge">FrozenStore</code> (where <code class="language-plaintext highlighter-rouge">cell</code> is <code class="language-plaintext highlighter-rouge">Identity</code>) within said context. <code class="language-plaintext highlighter-rouge">snapshotSTM</code> is a utility
to work with a <code class="language-plaintext highlighter-rouge">MonadSTM stm =&gt; Store stm</code> (i.e., snapshotting with <code class="language-plaintext highlighter-rouge">readTVar</code>), and <code class="language-plaintext highlighter-rouge">snapshot</code>
wraps <code class="language-plaintext highlighter-rouge">snapshotSTM</code> to run in a <code class="language-plaintext highlighter-rouge">MonadConc</code>.</p>

<p>We need <code class="language-plaintext highlighter-rouge">snapshotWith</code>, and not only <code class="language-plaintext highlighter-rouge">snapshotSTM</code>, for use in DejaFuâ€™s <code class="language-plaintext highlighter-rouge">Invariant</code> monad later.</p>

<h3 id="invariants">Invariants</h3>

<p>Finally, we can define <code class="language-plaintext highlighter-rouge">checkInvariants</code>, which ensures invariants are met in a <code class="language-plaintext highlighter-rouge">FrozenStore</code>.
If not, it throws an <code class="language-plaintext highlighter-rouge">InvariantViolation</code> exception:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">newtype</span> <span class="kt">InvariantViolation</span> <span class="o">=</span> <span class="kt">InvariantViolation</span> <span class="kt">String</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Show</span><span class="p">)</span>

<span class="kr">instance</span> <span class="kt">Exception</span> <span class="kt">InvariantViolation</span> <span class="kr">where</span>
  <span class="n">displayException</span> <span class="p">(</span><span class="kt">InvariantViolation</span> <span class="n">msg</span><span class="p">)</span> <span class="o">=</span> <span class="s">"Invariant violation: "</span> <span class="o">&lt;&gt;</span> <span class="n">msg</span>

<span class="n">invariantViolation</span> <span class="o">::</span> <span class="kt">MonadThrow</span> <span class="n">m</span> <span class="o">=&gt;</span> <span class="kt">String</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
<span class="n">invariantViolation</span> <span class="o">=</span> <span class="n">throwM</span> <span class="o">.</span> <span class="kt">InvariantViolation</span>

<span class="n">checkInvariants</span> <span class="o">::</span> <span class="kt">MonadThrow</span> <span class="n">m</span> <span class="o">=&gt;</span> <span class="kt">FrozenStore</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="nb">()</span>
<span class="n">checkInvariants</span> <span class="n">store</span> <span class="o">=</span> <span class="kr">do</span>
  <span class="kr">let</span> <span class="kt">Identity</span> <span class="n">a</span> <span class="o">=</span> <span class="n">storeA</span> <span class="n">store</span>
      <span class="kt">Identity</span> <span class="n">b</span> <span class="o">=</span> <span class="n">storeB</span> <span class="n">store</span>

  <span class="n">unless</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">$</span>
    <span class="n">invariantViolation</span> <span class="p">(</span><span class="s">"a + b /= 0, a = "</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="n">a</span> <span class="o">&lt;&gt;</span> <span class="s">", b = "</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="n">b</span><span class="p">)</span>
</code></pre></div></div>

<p>There are many ways to implement <code class="language-plaintext highlighter-rouge">checkInvariants</code>, and the above is only one of them. Some
alternatives include</p>

<ul>
  <li>
    <p>Making <code class="language-plaintext highlighter-rouge">checkInvariants</code> pure, returning, e.g., <code class="language-plaintext highlighter-rouge">Either String ()</code> or a <code class="language-plaintext highlighter-rouge">Bool</code> value, and
wrapping it later to turn a non-successful result into an exception (as required by DejaFu).</p>
  </li>
  <li>
    <p>Using the 
<a href="https://hackage.haskell.org/package/either-5.0.2/docs/Data-Either-Validation.html"><code class="language-plaintext highlighter-rouge">Validation</code> monad</a>
to capture all invariant violations instead of only the first one, and either returning
them or throwing them at the end.</p>
  </li>
</ul>

<h2 id="concurrent-access">Concurrent Access</h2>
<p>With the above code in place, hereâ€™s some code using a <code class="language-plaintext highlighter-rouge">Store</code>, mutating it
concurrently in various ways:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">-- | Add two values to a `Store`, concurrently.</span>
<span class="n">concurrentAdd</span> <span class="o">::</span> <span class="kt">MonadConc</span> <span class="n">m</span> <span class="o">=&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Store</span> <span class="p">(</span><span class="kt">STM</span> <span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="nb">()</span>
<span class="n">concurrentAdd</span> <span class="n">i</span> <span class="n">j</span> <span class="n">store</span> <span class="o">=</span>
  <span class="n">concurrently_</span>
    <span class="p">(</span><span class="n">add</span> <span class="n">i</span> <span class="n">store</span><span class="p">)</span>
    <span class="p">(</span><span class="n">add</span> <span class="n">j</span> <span class="n">store</span><span class="p">)</span>

<span class="cd">-- | Add two values to a `Store`, concurrently. With a bug.</span>
<span class="n">brokenConcurrentAdd</span> <span class="o">::</span> <span class="kt">MonadConc</span> <span class="n">m</span> <span class="o">=&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Store</span> <span class="p">(</span><span class="kt">STM</span> <span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="nb">()</span>
<span class="n">brokenConcurrentAdd</span> <span class="n">i</span> <span class="n">j</span> <span class="n">store</span> <span class="o">=</span>
  <span class="n">withAsync</span> <span class="p">(</span><span class="n">add</span> <span class="n">i</span> <span class="n">store</span><span class="p">)</span> <span class="o">$</span> <span class="nf">\</span><span class="n">a</span> <span class="o">-&gt;</span>
    <span class="n">withAsync</span> <span class="p">(</span><span class="n">add</span> <span class="n">j</span> <span class="n">store</span><span class="p">)</span> <span class="o">$</span> <span class="nf">\</span><span class="kr">_</span> <span class="o">-&gt;</span>
      <span class="n">wait</span> <span class="n">a</span>

<span class="cd">-- | Add and substract a value from a `Store`, concurrently.</span>
<span class="n">concurrentAddAndSub</span> <span class="o">::</span> <span class="kt">MonadConc</span> <span class="n">m</span> <span class="o">=&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="o">-&gt;</span> <span class="kt">Store</span> <span class="p">(</span><span class="kt">STM</span> <span class="n">m</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">m</span> <span class="nb">()</span>
<span class="n">concurrentAddAndSub</span> <span class="n">i</span> <span class="n">j</span> <span class="n">store</span> <span class="o">=</span>
  <span class="n">concurrently_</span>
    <span class="p">(</span><span class="n">add</span> <span class="n">i</span> <span class="n">store</span><span class="p">)</span>
    <span class="p">(</span><span class="n">sub</span> <span class="n">j</span> <span class="n">store</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="testing">Testing</h2>

<p>Finally, we can write some tests for the above code. First, <code class="language-plaintext highlighter-rouge">withStore</code> is a helper to
create a <code class="language-plaintext highlighter-rouge">Store'</code> (within the appropriate DejaFu <code class="language-plaintext highlighter-rouge">MonadConc</code> environment), and register
an invariant check. The latter will create a <code class="language-plaintext highlighter-rouge">FrozenStore</code> from the mutable one using
<code class="language-plaintext highlighter-rouge">snapshotWith inspectTVar</code>. <code class="language-plaintext highlighter-rouge">inspectTVar</code> is a function in DejaFuâ€™s <code class="language-plaintext highlighter-rouge">Invariant</code> monad
which allows to peek inside the contents of a <code class="language-plaintext highlighter-rouge">TVar</code> in the model:</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">withStore</span> <span class="o">::</span>
  <span class="kt">Monad</span> <span class="n">m</span> <span class="o">=&gt;</span>
  <span class="p">(</span><span class="kt">Store</span> <span class="p">(</span><span class="kt">STM</span> <span class="p">(</span><span class="kt">Program</span> <span class="kt">Basic</span> <span class="n">m</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="kt">Program</span> <span class="kt">Basic</span> <span class="n">m</span> <span class="n">a</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="kt">Program</span> <span class="p">(</span><span class="kt">WithSetup</span> <span class="p">(</span><span class="kt">Store</span> <span class="p">(</span><span class="kt">STM</span> <span class="p">(</span><span class="kt">Program</span> <span class="kt">Basic</span> <span class="n">m</span><span class="p">))))</span> <span class="n">m</span> <span class="n">a</span>
<span class="n">withStore</span> <span class="o">=</span> <span class="n">withSetup</span> <span class="o">$</span> <span class="kr">do</span>
  <span class="n">store</span> <span class="o">&lt;-</span> <span class="n">newStoreConc</span>

  <span class="n">registerInvariant</span> <span class="o">$</span>
    <span class="n">checkInvariants</span> <span class="o">=&lt;&lt;</span> <span class="n">snapshotWith</span> <span class="n">inspectTVar</span> <span class="n">store</span>

  <span class="n">pure</span> <span class="n">store</span>
</code></pre></div></div>

<p>Then, the tests. Each test runs the default DejaFu validations calling one of the
concurrent functions on a provisioned <code class="language-plaintext highlighter-rouge">Store'</code>, and returns a snapshot of the
store. DejaFu will then check whether every interleaving of concurrent actions
results in the same value/state.</p>

<div class="language-haskell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">main</span> <span class="o">::</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="n">main</span> <span class="o">=</span> <span class="n">defaultMain</span> <span class="o">$</span> <span class="n">testGroup</span> <span class="s">"store-app"</span> <span class="p">[</span>
  <span class="n">testAuto</span> <span class="s">"concurrentAdd"</span> <span class="o">$</span> <span class="n">withStore</span> <span class="o">$</span> <span class="nf">\</span><span class="n">store</span> <span class="o">-&gt;</span> <span class="kr">do</span>
    <span class="n">concurrentAdd</span> <span class="mi">10</span> <span class="mi">20</span> <span class="n">store</span>

    <span class="n">snapshot</span> <span class="n">store</span><span class="p">,</span>

  <span class="n">testAuto</span> <span class="s">"brokenConcurrentAdd"</span> <span class="o">$</span> <span class="n">withStore</span> <span class="o">$</span> <span class="nf">\</span><span class="n">store</span> <span class="o">-&gt;</span> <span class="kr">do</span>
    <span class="n">brokenConcurrentAdd</span> <span class="mi">10</span> <span class="mi">20</span> <span class="n">store</span>

    <span class="n">snapshot</span> <span class="n">store</span><span class="p">,</span>

  <span class="n">testAuto</span> <span class="s">"concurrentAddAndSub"</span> <span class="o">$</span> <span class="n">withStore</span> <span class="o">$</span> <span class="nf">\</span><span class="n">store</span> <span class="o">-&gt;</span> <span class="kr">do</span>
    <span class="n">concurrentAddAndSub</span> <span class="mi">10</span> <span class="mi">20</span> <span class="n">store</span>

    <span class="n">snapshot</span> <span class="n">store</span>
  <span class="p">]</span>
</code></pre></div></div>

<p>The first test succeeds, as desired:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>store-app
  concurrentAdd
    Never Deadlocks:   OK (0.13s)
    No Exceptions:     OK (0.02s)
    Consistent Result: OK (0.02s)
</code></pre></div></div>

<p>The second one, however, fails, as expected:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  brokenConcurrentAdd
    Never Deadlocks:   OK
    No Exceptions:     OK
    Consistent Result: FAIL
      Failed:
        Store' {storeA = Identity 30, storeB = Identity (-30)} S0-----------S1---------S0---S2---------S0-------------

        Store' {storeA = Identity 10, storeB = Identity (-10)} S0-----------S1---------S0---S2--P0---S2---S0-----------

      Use -p '/brokenConcurrentAdd.Consistent Result/' to rerun this test only.
</code></pre></div></div>

<p>Indeed, <code class="language-plaintext highlighter-rouge">brokenConcurrentAdd</code> fails to <code class="language-plaintext highlighter-rouge">wait</code> for the inner <code class="language-plaintext highlighter-rouge">Async</code>. Hence, there are
two possible interleavings: one where the second <code class="language-plaintext highlighter-rouge">add</code> succeeds before the thread
running it is killed (the first interleaving above, where <code class="language-plaintext highlighter-rouge">storeA</code> is <code class="language-plaintext highlighter-rouge">30</code>), or another
one where the thread is killed before its <code class="language-plaintext highlighter-rouge">add</code> action has completed, and the
snapshotted state has <code class="language-plaintext highlighter-rouge">10</code> in <code class="language-plaintext highlighter-rouge">storeA</code> (the second interleaving above).</p>

<p>The last test also fails, in this case not because some concurrency bug as above,
but because the invariants we expect our state to adhere to are violated:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  concurrentAddAndSub
    Never Deadlocks:   OK
    No Exceptions:     OK
    Consistent Result: FAIL
      Failed:
        [invariant failure] S0-------S1--------S2---

        [invariant failure] S0-------S2---

      Use -p '/concurrentAddAndSub.Consistent Result/' to rerun this test only.

2 out of 9 tests failed (0.19s)
</code></pre></div></div>

<p>Indeed, once the second thread (which runs <code class="language-plaintext highlighter-rouge">sub j store</code>) ran, no matter
whether the first thread (running <code class="language-plaintext highlighter-rouge">add i store</code>) ran before or not, the <code class="language-plaintext highlighter-rouge">a + b == 0</code>
invariant no longer holds. Indeed, thereâ€™s a bug in the <code class="language-plaintext highlighter-rouge">subSTM</code> function: instead of
substracting <code class="language-plaintext highlighter-rouge">i</code> from <code class="language-plaintext highlighter-rouge">storeB</code>, it should add it.</p>

<p>Sadly, at this point <code class="language-plaintext highlighter-rouge">tasty-dejafu</code> wonâ€™t show which exception was raised
while checking invariants, and only displays <code class="language-plaintext highlighter-rouge">invariant failure</code>. I opened an
<a href="https://github.com/barrucadu/dejafu/issues/385">issue</a> to maybe improve this.</p>

<h2 id="conclusion">Conclusion</h2>
<p>STM allows for safe concurrent access to shared mutable state with fine-grained
locking. However, when multiple variables are at play, defining invariants between
their values and ensuring these invariants arenâ€™t breached in some interleaving
of concurrent mutations is important. The DejaFu library can help to achieve this,
so building your code on the <code class="language-plaintext highlighter-rouge">concurrency</code> abstractions from the start allows to
write all kinds of tests later.</p>

<h3 id="future-work">Future Work</h3>
<ul>
  <li>
    <p>The trick used above to use <code class="language-plaintext highlighter-rouge">Identity</code> as the <code class="language-plaintext highlighter-rouge">cell</code> type allows for immutable
versions of the data type bundling all variables. However, the <code class="language-plaintext highlighter-rouge">Identity</code> wrapper
is a bit of a burden when dissecting <code class="language-plaintext highlighter-rouge">FrozenStore</code>. Itâ€™d be nice if <code class="language-plaintext highlighter-rouge">cell a</code> could
become a plain <code class="language-plaintext highlighter-rouge">a</code> removing the need to unpack the <code class="language-plaintext highlighter-rouge">Identity</code> constructor. I have
a hunch this might be possible by using some closed type family, but didnâ€™t pursue
this further yet.</p>
  </li>
  <li>
    <p>Implementing <code class="language-plaintext highlighter-rouge">snapshotWith</code> is quite boring. I imagine itâ€™s possible to have
a generic version of it using <code class="language-plaintext highlighter-rouge">GHC.Generics</code>.</p>
  </li>
  <li>
    <p>Using the <code class="language-plaintext highlighter-rouge">concurrency</code> abstraction brings a <code class="language-plaintext highlighter-rouge">MonadConc</code> or <code class="language-plaintext highlighter-rouge">MonadSTM</code> constraint
and hence a dictionary lookup at runtime. Iâ€™d love to see some benchmarks where
a library is defined in terms of <code class="language-plaintext highlighter-rouge">MonadConc</code> and <code class="language-plaintext highlighter-rouge">MonadSTM</code>, but every function
is <code class="language-plaintext highlighter-rouge">INLINEABLE</code> and/or <code class="language-plaintext highlighter-rouge">SPECIALIZE</code>d to <code class="language-plaintext highlighter-rouge">Control.Concurrent.STM.STM</code> and <code class="language-plaintext highlighter-rouge">IO</code> so
thereâ€™s, ideally, no performance hit for <em>regular application</em> consumers of the
library vs. using plain <code class="language-plaintext highlighter-rouge">STM</code> and <code class="language-plaintext highlighter-rouge">IO</code> in the library code. [Update: <a href="/development/concurrency-and-performance/">hereâ€™s the
answer</a>]</p>
  </li>
</ul>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#development" class="page__taxonomy-item p-category" rel="tag">Development</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2023-04-14">April 14, 2023</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?via=eikke&text=Testing+concurrent+code+using+DejaFu%20https%3A%2F%2Fnicolast.be%2Fdevelopment%2Ftesting-concurrent-code-using-dejafu%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fnicolast.be%2Fdevelopment%2Ftesting-concurrent-code-using-dejafu%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://nicolast.be/development/testing-concurrent-code-using-dejafu/" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/development/xinu-a-haskell-experiment/" class="pagination--pager" title="xinU, a Haskell Experiment
">Previous</a>
    
    
      <a href="/various/jekyll-literate-haskell/" class="pagination--pager" title="Using Literate Haskell with Jekyll
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    
<div class="page__related">
  
  <h2 class="page__related-title">You may also enjoy</h2>
  <div class="grid__wrapper">
    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/development/concurrency-and-performance/" rel="permalink"><code class="language-plaintext highlighter-rouge">concurrency</code> and Performance
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          12 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Testing concurrent code using DejaFu requires the use of MonadConc and MonadSTM instead of plain IO and STM. Is there any performance impact, and if there is...</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/various/jekyll-literate-haskell/" rel="permalink">Using Literate Haskell with Jekyll
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          4 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">With a little bit of configuration, Haskell code in Jekyll articles can be executed or loaded in a REPL: a great way to ensure the code actually works!
</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/development/xinu-a-haskell-experiment/" rel="permalink">xinU, a Haskell Experiment
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          7 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Thanks to its extensive FFI support, Haskell is a great platform to develop system applications. The unix library exposes a large set of POSIX APIs to Haskel...</p>
  </article>
</div>

    
      
      



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/development/a-git-branching-model-for-releases-with-generated-files/" rel="permalink">A Git Branching Model for Releases with Generated Files
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 minute read
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Version Control Systems and generated files donâ€™t play nice together, though for some projects such files need to be included in release packages. This artic...</p>
  </article>
</div>

    
  </div>
</div>

  
  
</div>

      
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/eikke" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/NicolasT" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 <a href="https://nicolast.be">nicolast.be</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>







  <script>
  window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
  ga('create','UA-91109342-1','auto');
  ga('set', 'anonymizeIp', false);
  ga('send','pageview')
</script>
<script src="https://www.google-analytics.com/analytics.js" async></script>








  </body>
</html>
